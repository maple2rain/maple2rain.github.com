---
layout: post
title: 主存与Cache的地址映像
date: 2016-08-10 19:34:42
updated: 2017-02-21 16:15:46
tags:
- Principle
categories:
- Study
- Computer
- Hardware
- Advanced
---

* content
{:toc}

本文主要介绍主存如何与Cache地址进行映像处理。




## 1 cache 

与主存容量相比，Cache的容量很小，它所保存的信息仅是主存信息的一个子集，且 cache与主存的信息交换是以块为单位。为了把信息放到Cache中，必须事先规定好主存与cache之间的地址映像方式，即某一个Cache块可以作 为哪些主存块的副本(即映像)。映像方式一旦确定，就决定了访问Cache时对主存地址的理解，因而也就决定了Cache的组织结构。目前有三种地址映像 方式：直接映像、全相联映像和组相联映像。

## 2 地址映像种类

### 2.1 直接映像(Direct Mapping)

采用直接映像时，Cache的某一块只能和固定的一些主存块建立映像关系，主存的某一块只能对应一个Cache块。

直接映像关系可定义为$$K = I \% 2^c$$

其中，K为Cache的块号；I为主存的块号；$2^c$为Cache块数。

- 优点

    硬件简单、成本低

- 缺点

    不够灵活，主存的若干块只能对应惟一的Cache块，即使Cache中还有空位，也不能利用。



### 2.2 全相联映像(Associative Mapping)

采用全相联映像时，Cache的某一块可以和任一主存块建立映像关系，而主存中某一块也可以映像到(2ache中任一块位置上。由于Cache的某一块可 以和任一主存块建立映像关系，所以Cache的标记部分必须记录主存块块地址的全部信息。

例如，主存分为2n块，块的地址为n位，标记也应为n位。 采用全相联映像方式时，主存地址被理解为由两部分组成：标记(主存块号)和块内地址。CPU 在访问存储器时，为了判断是否命中，主存地址的标记部分需要和Cache的所有块的标记进行比较。为了缩短比较的时间，将主存地址的标记部分和Cache 的所有块的标记同时进行比较。如果命中，则按块内地址访问Cache中的命中块(其标记与主存地址给出的标记相同)；如果未命中，则访问主存。

- 优点

    灵活，Cache利用率高。

- 缺点 

    - 标记位数增加了(需要记录主存块块地址的全部信息)，使得Cache的电路规模变 大，成本变高；

    - 比较器难于设计和实现(通常采用“按内容寻址的”相联存储器)。因此，只有小容量Cache才采用这种映像方式。



### 2.3 组相联映像(Set Associative Mapping)

组相联映像方式是介于直接映像和全相联映像之间的一种折中方案。

设Cache中共有m个块，在采用组相联映像方式时，将m个Cache块分成u组(set)，每组k个块(即m=u×k)，组间直接映像，而组内全相联映像。

所谓组间直接映像，是指某组中的Cache块只能与固定的一些主存块建立映像关系。这种映像关系可用下式表示：

$$i = j \% n$$

其中i为Cache组的编号,j为主存块的编号，n为Cache的组数。



例如，Cache第0组只能和满足$i \% u = 0$的主存块(即第0块、第u块、第2u块……)建立映像关系，Cache第1组只能和满足$i \% u = 1$的主存块(即第l块、第u+1块、第2u+l块……)建立映像关系。

所谓组内全相联映像，是指和某Cache组相对应的主存块可以和该组内的任意一 个Cache块建立映像关系。



组相联映像的性能及复杂性介于直接映像和全相联映像之间。事实上直接映像和全相联映像可看成组相联的两种极端情况：直接映像对应的是u=m、 K=1，全相联映像对应的是u=1、K=m。组相联映像方式中的每组块数K一般取值较小，典型值是2、4、8、16。这种规模的K路比较器容易设计和实 现，而主存块在Cache组内的存放又有一定的灵活性。因此实际应用中多数采用组相联映像方式。通常将每组K个块的Cache称为k路组相联(K-Way Set Associative Mapping)Cache。